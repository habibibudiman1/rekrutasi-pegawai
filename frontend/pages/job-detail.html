<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Lowongan - Rekrutasi Pegawai</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold text-primary" href="index.html">
                <i class="bi bi-briefcase-fill me-2"></i>RekrutasiPegawai
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <nav class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="jobs.html">Lowongan Pekerjaan</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">Tentang Kami</a>
                    </li>
                    <li class="nav-item" id="authNav">
                        <a class="nav-link" href="login.html">Masuk</a>
                    </li>
                    <li class="nav-item" id="registerNav">
                        <a class="nav-link btn btn-primary text-white px-3 rounded-pill ms-2" href="register.html">Daftar</a>
                    </li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <div class="container" style="margin-top: 100px;">
        <div id="jobDetail">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Apply Modal -->
    <div class="modal fade" id="applyModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Lamar Pekerjaan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="applyForm">
                        <input type="hidden" id="applyJobId">
                        <div class="mb-3">
                            <label for="coverLetterFile" class="form-label">Upload Surat Lamaran (PDF) <small class="text-muted">(Opsional)</small></label>
                            <input type="file" class="form-control" id="coverLetterFile" accept=".pdf">
                            <small class="text-muted">Format: PDF, Maksimal 5MB</small>
                        </div>
                        <div class="mb-3">
                            <label for="cvFile" class="form-label">Upload CV (PDF)</label>
                            <input type="file" class="form-control" id="cvFile" accept=".pdf" required>
                            <small class="text-muted">Format: PDF, Maksimal 5MB</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" id="submitApplicationBtn">Kirim Lamaran</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <script src="/js/supabase-init.js"></script>
    <script src="/js/modules/auth.js"></script>
    <script src="/js/main.js"></script>
    <script src="/js/modules/jobs.js"></script>
    <script src="/js/modules/applications.js"></script>
    <script>
        let currentJob = null;
        let hasApplied = false;

        async function loadJobDetail() {
            try {
                // Wait for Supabase to be ready
                await authManager.waitForSupabase(5000);
                
                // Get jobId from URL - try multiple methods
                let jobId = null;
                
                // Method 1: URLSearchParams (standard)
                const urlParams = new URLSearchParams(window.location.search);
                jobId = urlParams.get('id');
                
                // Method 2: Direct parsing if Method 1 fails
                if (!jobId && window.location.search) {
                    const match = window.location.search.match(/[?&]id=([^&]+)/);
                    if (match && match[1]) {
                        jobId = decodeURIComponent(match[1]);
                    }
                }
                
                // Method 3: Check hash (for SPA routing)
                if (!jobId && window.location.hash) {
                    const hashParams = new URLSearchParams(window.location.hash.substring(1));
                    jobId = hashParams.get('id');
                }

                console.log('loadJobDetail: Full URL:', window.location.href);
                console.log('loadJobDetail: URL pathname:', window.location.pathname);
                console.log('loadJobDetail: URL search:', window.location.search);
                console.log('loadJobDetail: URL hash:', window.location.hash);
                console.log('loadJobDetail: jobId from URL:', jobId);

                if (!jobId) {
                    console.error('loadJobDetail: No jobId in URL');
                    console.error('loadJobDetail: Full URL:', window.location.href);
                    console.error('loadJobDetail: Search params:', window.location.search);
                    
                    // Try to get jobId from sessionStorage (if user clicked from jobs list)
                    const storedJobId = sessionStorage.getItem('lastViewedJobId');
                    if (storedJobId) {
                        console.log('loadJobDetail: Found jobId in sessionStorage:', storedJobId);
                        jobId = storedJobId;
                        // Update URL without reload
                        const newUrl = window.location.pathname + '?id=' + encodeURIComponent(jobId);
                        window.history.replaceState({}, '', newUrl);
                    } else {
                        // No jobId found, show error and redirect after 3 seconds
                        document.getElementById('jobDetail').innerHTML = `
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                <strong>ID Lowongan Tidak Ditemukan</strong>
                                <p class="mb-0 mt-2">Halaman ini memerlukan parameter ID lowongan. Anda akan diarahkan ke halaman daftar lowongan dalam <span id="countdown">3</span> detik.</p>
                                <div class="mt-3">
                                    <a href="jobs.html" class="btn btn-primary me-2">
                                        <i class="bi bi-arrow-left me-2"></i>Kembali ke Daftar Lowongan
                                    </a>
                                    <a href="index.html" class="btn btn-outline-secondary">
                                        <i class="bi bi-house me-2"></i>Kembali ke Home
                                    </a>
                                </div>
                            </div>
                        `;
                        
                        // Auto-redirect after 3 seconds
                        let countdown = 3;
                        const countdownEl = document.getElementById('countdown');
                        const redirectInterval = setInterval(() => {
                            countdown--;
                            if (countdownEl) {
                                countdownEl.textContent = countdown;
                            }
                            if (countdown <= 0) {
                                clearInterval(redirectInterval);
                                window.location.href = 'jobs.html';
                            }
                        }, 1000);
                        
                        return;
                    }
                }

                // Trim whitespace from jobId
                const trimmedJobId = jobId.trim();
                if (trimmedJobId !== jobId) {
                    console.warn('loadJobDetail: jobId had whitespace, trimmed:', trimmedJobId);
                }

                // Try to get job using jobsManager
                console.log('loadJobDetail: Calling jobsManager.getJobById with:', trimmedJobId);
                currentJob = await jobsManager.getJobById(trimmedJobId);
                
                // If jobsManager fails, try direct query as fallback
                if (!currentJob) {
                    console.warn('loadJobDetail: jobsManager.getJobById failed, trying direct query...');
                    const supabaseClient = authManager.getSupabaseClient();
                    if (supabaseClient) {
                        try {
                            console.log('loadJobDetail: Direct query with jobId:', trimmedJobId);
                            const { data, error } = await supabaseClient
                                .from('jobs')
                                .select('*')
                                .eq('id', trimmedJobId)
                                .eq('is_active', true)
                                .maybeSingle();
                            
                            if (!error && data) {
                                currentJob = data;
                                console.log('loadJobDetail: Job loaded via direct query');
                            } else if (error) {
                                console.error('loadJobDetail: Direct query error:', error);
                            } else {
                                console.warn('loadJobDetail: Direct query returned no data');
                            }
                        } catch (error) {
                            console.error('loadJobDetail: Direct query exception:', error);
                        }
                    } else {
                        console.error('loadJobDetail: No Supabase client available for direct query');
                    }
                }
                
                if (!currentJob) {
                    document.getElementById('jobDetail').innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Lowongan tidak ditemukan</strong>
                            <p class="mb-0 mt-2">Lowongan yang Anda cari tidak ditemukan atau sudah tidak aktif.</p>
                            <a href="jobs.html" class="btn btn-primary mt-3">
                                <i class="bi bi-arrow-left me-2"></i>Kembali ke Daftar Lowongan
                            </a>
                        </div>
                    `;
                    return;
                }

                // Check if user has applied
                try {
                    if (await authManager.isAuthenticated()) {
                        hasApplied = await applicationsManager.getApplicationByJob(trimmedJobId);
                    }
                } catch (error) {
                    console.warn('Error checking application status:', error);
                    hasApplied = false;
                }

                displayJobDetail(currentJob);
            } catch (error) {
                console.error('Error loading job detail:', error);
                document.getElementById('jobDetail').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Terjadi kesalahan</strong>
                        <p class="mb-0 mt-2">Gagal memuat detail lowongan. Silakan refresh halaman atau coba lagi nanti.</p>
                        <a href="jobs.html" class="btn btn-primary mt-3">
                            <i class="bi bi-arrow-left me-2"></i>Kembali ke Daftar Lowongan
                        </a>
                    </div>
                `;
            }
        }

        async function displayJobDetail(job) {
            const container = document.getElementById('jobDetail');
            
            // Check authentication status
            const isAuthenticated = await authManager.isAuthenticated();
            
            container.innerHTML = `
                <div class="row">
                    <div class="col-lg-8">
                        <div class="card shadow-sm mb-4">
                            <div class="card-body">
                                <h1 class="fw-bold mb-3">${job.title}</h1>
                                <div class="mb-3">
                                    <span class="job-badge bg-primary text-white me-2">${job.category || 'N/A'}</span>
                                    <span class="job-badge bg-secondary text-white me-2">${job.employment_type || 'N/A'}</span>
                                    ${job.salary_min ? `<span class="job-badge bg-success text-white">${formatCurrency(job.salary_min)} - ${formatCurrency(job.salary_max || job.salary_min)}</span>` : ''}
                                </div>
                                <p class="text-muted mb-4">
                                    <i class="bi bi-building me-2"></i>${job.company}
                                    <span class="ms-3"><i class="bi bi-geo-alt me-2"></i>${job.location || 'N/A'}</span>
                                    <span class="ms-3"><i class="bi bi-calendar me-2"></i>Diposting: ${formatDate(job.created_at)}</span>
                                </p>

                                <hr>

                                <h4 class="fw-bold mb-3">Deskripsi Pekerjaan</h4>
                                <div class="mb-4">
                                    ${job.description.split('\n').map(p => `<p>${p}</p>`).join('')}
                                </div>

                                <h4 class="fw-bold mb-3">Persyaratan</h4>
                                <div>
                                    ${job.requirements.split('\n').map(p => `<p>${p}</p>`).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="card shadow-sm sticky-top" style="top: 100px;">
                            <div class="card-body">
                                <h5 class="fw-bold mb-3">Informasi Lowongan</h5>
                                <div class="mb-3">
                                    <strong>Perusahaan:</strong><br>
                                    <span>${job.company}</span>
                                </div>
                                <div class="mb-3">
                                    <strong>Lokasi:</strong><br>
                                    <span>${job.location || 'N/A'}</span>
                                </div>
                                <div class="mb-3">
                                    <strong>Kategori:</strong><br>
                                    <span>${job.category || 'N/A'}</span>
                                </div>
                                <div class="mb-3">
                                    <strong>Jenis Pekerjaan:</strong><br>
                                    <span>${job.employment_type || 'N/A'}</span>
                                </div>
                                ${job.salary_min ? `
                                <div class="mb-3">
                                    <strong>Gaji:</strong><br>
                                    <span>${formatCurrency(job.salary_min)} - ${formatCurrency(job.salary_max || job.salary_min)}</span>
                                </div>
                                ` : ''}
                                <hr>
                                ${hasApplied 
                                    ? '<div class="alert alert-info"><i class="bi bi-info-circle me-2"></i>Anda sudah melamar untuk lowongan ini</div>'
                                    : isAuthenticated
                                        ? `<button class="btn btn-primary w-100 btn-lg" onclick="openApplyModal()">
                                            <i class="bi bi-send me-2"></i>Lamar Sekarang
                                        </button>`
                                        : `<a href="login.html" class="btn btn-primary w-100 btn-lg">
                                            <i class="bi bi-box-arrow-in-right me-2"></i>Masuk untuk Melamar
                                        </a>`
                                }
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        async function openApplyModal() {
            const isAuth = await authManager.isAuthenticated();
            if (!isAuth) {
                window.location.href = 'login.html';
                return;
            }

            if (!currentJob) {
                showAlert('Lowongan tidak ditemukan', 'danger');
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('applyModal'));
            document.getElementById('applyForm').reset();
            document.getElementById('applyJobId').value = currentJob.id;
            modal.show();
        }

        async function submitApplication() {
            const jobId = document.getElementById('applyJobId').value;
            const coverLetterFile = document.getElementById('coverLetterFile').files[0] || null;
            const cvFile = document.getElementById('cvFile').files[0];

            // Validation
            if (!cvFile) {
                showAlert('Silakan upload CV Anda', 'warning');
                return;
            }

            // Validate file sizes (5MB = 5 * 1024 * 1024 bytes)
            const maxSize = 5 * 1024 * 1024;

            if (coverLetterFile) {
                if (coverLetterFile.size > maxSize) {
                    showAlert('Ukuran file Surat Lamaran terlalu besar. Maksimal 5MB', 'danger');
                    return;
                }
                if (coverLetterFile.type !== 'application/pdf') {
                    showAlert('Format file Surat Lamaran harus PDF', 'danger');
                    return;
                }
            }

            if (cvFile.size > maxSize) {
                showAlert('Ukuran file CV terlalu besar. Maksimal 5MB', 'danger');
                return;
            }

            if (cvFile.type !== 'application/pdf') {
                showAlert('Format file CV harus PDF', 'danger');
                return;
            }

            const submitBtn = document.getElementById('submitApplicationBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Memproses...';

            const applicationData = {
                coverLetter: null,
                coverLetterFile: coverLetterFile,
                cvFile: cvFile
            };

            try {
                const result = await applicationsManager.applyForJob(jobId, applicationData);

                if (result.success) {
                    showAlert('Lamaran berhasil dikirim!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('applyModal')).hide();
                    hasApplied = true;
                    await loadJobDetail();
                } else {
                    showAlert('Error: ' + result.error, 'danger');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Kirim Lamaran';
                }
            } catch (error) {
                console.error('Error submitting application:', error);
                showAlert('Terjadi kesalahan: ' + error.message, 'danger');
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Kirim Lamaran';
            }
        }

        document.getElementById('submitApplicationBtn').addEventListener('click', submitApplication);

        // Function to force update navigation
        async function forceUpdateNavigation() {
            const isAuth = await authManager.isAuthenticated();
            console.log('forceUpdateNavigation: isAuth =', isAuth);
            
            // Find elements by ID first (more reliable)
            const authNav = document.getElementById('authNav');
            const registerNav = document.getElementById('registerNav');
            
            if (authNav && registerNav) {
                const loginLink = authNav.querySelector('a');
                const registerLink = registerNav.querySelector('a');
                
                if (loginLink && registerLink) {
                    if (isAuth) {
                        // Update to Dashboard/Logout
                        loginLink.textContent = 'Dashboard';
                        loginLink.href = 'dashboard-pelamar.html'; // Default, will be updated by main.js
                        loginLink.onclick = null;
                        
                        registerLink.className = 'nav-link';
                        registerLink.textContent = 'Logout';
                        registerLink.href = '#';
                        registerLink.onclick = null;
                        registerLink.addEventListener('click', async (e) => {
                            e.preventDefault();
                            await authManager.logout();
                            window.location.href = 'index.html';
                        });
                        
                        // Get profile to set correct dashboard
                        try {
                            const profile = await authManager.getCurrentUserProfile();
                            if (profile && profile.role === 'HRD') {
                                loginLink.href = 'dashboard-hrd.html';
                            }
                        } catch (error) {
                            console.warn('Error getting profile:', error);
                        }
                        
                        console.log('Navigation force updated: Dashboard/Logout');
                    } else {
                        // Update to Masuk/Daftar
                        loginLink.textContent = 'Masuk';
                        loginLink.href = 'login.html';
                        loginLink.onclick = null;
                        
                        registerLink.className = 'nav-link btn btn-primary text-white px-3 rounded-pill ms-2';
                        registerLink.textContent = 'Daftar';
                        registerLink.href = 'register.html';
                        registerLink.onclick = null;
                        
                        console.log('Navigation force updated: Masuk/Daftar');
                    }
                }
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            // Wait for Supabase to be ready
            await authManager.waitForSupabase(5000);
            
            // Wait a bit for DOM to be fully ready
            await new Promise(resolve => setTimeout(resolve, 300));
            
            // Force update navigation first
            await forceUpdateNavigation();
            
            // Then call updateNavigation from main.js
            await updateNavigation();
            
            // Then load job detail
            await loadJobDetail();
        });
        
        // Also update navigation when page becomes visible (in case of back navigation)
        document.addEventListener('visibilitychange', async () => {
            if (!document.hidden) {
                await authManager.waitForSupabase(2000);
                await forceUpdateNavigation();
                await updateNavigation();
            }
        });
    </script>
</body>
</html>

